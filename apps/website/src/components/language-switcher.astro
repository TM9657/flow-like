---
import type { Lang } from "../i18n";
import { languages, defaultLang } from "../i18n";

interface Props {
  lang?: Lang;
}

const { lang = defaultLang } = Astro.props;
const currentPath = Astro.url.pathname;

const langFlags: Record<string, string> = {
  en: "ğŸ‡ºğŸ‡¸",
  de: "ğŸ‡©ğŸ‡ª",
  es: "ğŸ‡ªğŸ‡¸",
  fr: "ğŸ‡«ğŸ‡·",
  zh: "ğŸ‡¨ğŸ‡³",
  ja: "ğŸ‡¯ğŸ‡µ",
  ko: "ğŸ‡°ğŸ‡·",
  pt: "ğŸ‡§ğŸ‡·",
  it: "ğŸ‡®ğŸ‡¹",
  nl: "ğŸ‡³ğŸ‡±",
  sv: "ğŸ‡¸ğŸ‡ª",
};

function getLocalizedPath(targetLang: Lang) {
  let path = currentPath;
  for (const l of Object.keys(languages)) {
    if (path.startsWith(`/${l}/`) || path === `/${l}`) {
      path = path.slice(l.length + 1) || "/";
      break;
    }
  }
  if (targetLang === defaultLang) {
    return path || "/";
  }
  return `/${targetLang}${path === "/" ? "" : path}`;
}
---

<div class="lang-switcher-container">
  <button
    id="lang-toggle"
    class="group flex items-center gap-2 rounded-full border border-border/40 bg-background/60 px-3 py-1.5 text-sm font-medium backdrop-blur-md transition-all hover:border-primary/50 hover:bg-background/80 hover:shadow-lg hover:shadow-primary/5"
    aria-label="Select language"
  >
    <span class="text-base leading-none">{langFlags[lang]}</span>
    <span class="hidden sm:inline uppercase text-foreground/70 group-hover:text-foreground transition-colors">{lang}</span>
    <svg class="size-3 opacity-50 transition-transform group-hover:opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Desktop dropdown -->
  <div
    id="lang-menu-desktop"
    class="hidden sm:block absolute right-0 top-full z-50 mt-2 opacity-0 invisible translate-y-2 transition-all duration-200 pointer-events-none"
  >
    <div class="grid grid-cols-2 gap-1 p-2 rounded-xl border border-border/50 bg-background/95 shadow-xl shadow-black/10 backdrop-blur-lg min-w-[240px]">
      {Object.entries(languages).map(([code, name]) => (
        <a
          href={getLocalizedPath(code as Lang)}
          class:list={[
            "flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-all",
            code === lang
              ? "bg-primary/10 text-primary font-medium ring-1 ring-primary/20"
              : "text-foreground/70 hover:bg-muted hover:text-foreground",
          ]}
        >
          <span class="text-lg">{langFlags[code]}</span>
          <span>{name}</span>
        </a>
      ))}
    </div>
  </div>

  <!-- Mobile bottom sheet -->
  <div
    id="lang-sheet-overlay"
    class="sm:hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm opacity-0 invisible transition-opacity duration-300"
  />
  <div
    id="lang-sheet"
    class="sm:hidden fixed inset-x-0 bottom-0 z-50 translate-y-full transition-transform duration-300 ease-out"
  >
    <div class="bg-background rounded-t-2xl border-t border-border/50 shadow-2xl pb-safe">
      <div class="flex justify-center pt-3 pb-2">
        <div class="w-10 h-1 rounded-full bg-muted-foreground/30" />
      </div>
      <div class="px-4 pb-2">
        <h3 class="text-lg font-semibold text-foreground">Select Language</h3>
      </div>
      <div class="grid grid-cols-2 gap-2 p-4 pt-2 max-h-[60vh] overflow-y-auto">
        {Object.entries(languages).map(([code, name]) => (
          <a
            href={getLocalizedPath(code as Lang)}
            class:list={[
              "flex items-center gap-3 px-4 py-3 rounded-xl text-base transition-all active:scale-95",
              code === lang
                ? "bg-primary/10 text-primary font-medium ring-2 ring-primary/30"
                : "bg-muted/50 text-foreground/80 hover:bg-muted",
            ]}
          >
            <span class="text-2xl">{langFlags[code]}</span>
            <span>{name}</span>
          </a>
        ))}
      </div>
      <div class="p-4 pt-0">
        <button
          id="lang-sheet-close"
          class="w-full py-3 rounded-xl bg-muted text-foreground/70 font-medium transition-colors hover:bg-muted/80 active:scale-[0.98]"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .lang-switcher-container {
    position: relative;
  }

  #lang-menu-desktop.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  #lang-sheet-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  #lang-sheet.open {
    transform: translateY(0);
  }

  .pb-safe {
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }
</style>

<script>
  const toggle = document.getElementById("lang-toggle");
  const menuDesktop = document.getElementById("lang-menu-desktop");
  const sheetOverlay = document.getElementById("lang-sheet-overlay");
  const sheet = document.getElementById("lang-sheet");
  const sheetClose = document.getElementById("lang-sheet-close");

  const isMobile = () => window.innerWidth < 640;

  function openMenu() {
    if (isMobile()) {
      sheetOverlay?.classList.add("open");
      sheet?.classList.add("open");
      document.body.style.overflow = "hidden";
    } else {
      menuDesktop?.classList.add("open");
    }
  }

  function closeMenu() {
    menuDesktop?.classList.remove("open");
    sheetOverlay?.classList.remove("open");
    sheet?.classList.remove("open");
    document.body.style.overflow = "";
  }

  toggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = menuDesktop?.classList.contains("open") || sheet?.classList.contains("open");
    if (isOpen) {
      closeMenu();
    } else {
      openMenu();
    }
  });

  sheetOverlay?.addEventListener("click", closeMenu);
  sheetClose?.addEventListener("click", closeMenu);

  document.addEventListener("click", (e) => {
    if (!toggle?.contains(e.target as Node) && !menuDesktop?.contains(e.target as Node)) {
      closeMenu();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMenu();
  });
</script>
