---
/**
 * Newsletter CTA for blog posts - a compact inline version
 */
import type { Lang, TranslationKey } from "../i18n";
import { translations, defaultLang } from "../i18n";

interface Props {
  lang?: Lang;
}

const { lang = defaultLang } = Astro.props;
const t = (key: TranslationKey): string => {
  const langTranslations = translations[lang] as Record<string, string>;
  const enTranslations = translations.en as Record<string, string>;
  return langTranslations?.[key] ?? enTranslations[key] ?? key;
};

const formAction = "https://650afa0c.sibforms.com/serve/MUIFAFXOXcuOw6rHKrCvv5lDLbFzAZJDpDAfNCOt5PX8ibIwurqvFXXjTBiRQHJU9rldi-SiK988AtVd5MEKj1u2JhcKWMLmhfhbtq_aXC0IJGczM6v3mvf06FjJaUbU6_KXQIGVcbVQNYHAQuwlyT0EeHtx_NVrGtHOE4rlyg3PTicbGv2e_q4HrAnizfNvDIfAr9CtcGdyz0DsTQ==";
const turnstileSiteKey = "0x4AAAAAACLfuGyDAsHciBgR";
---

<div class="not-prose my-12 p-6 rounded-xl border border-border bg-muted/30">
  <div class="max-w-lg mx-auto">
    <h3 class="text-lg font-semibold text-foreground mb-2">
      {t("newsletter.headline")}
    </h3>
    <p class="text-sm text-muted-foreground mb-4">
      {t("newsletter.description")}
    </p>

    <form
      id="blog-newsletter-form"
      method="POST"
      action={formAction}
      data-type="subscription"
      class="space-y-3"
    >
      <div
        id="blog-newsletter-error"
        class="hidden p-2.5 rounded-lg bg-destructive/10 border border-destructive/20 text-destructive text-xs"
        role="alert"
      >
        {t("newsletter.error")}
      </div>

      <div
        id="blog-newsletter-success"
        class="hidden p-2.5 rounded-lg bg-green-500/10 border border-green-500/20 text-green-700 dark:text-green-400 text-xs"
        role="status"
      >
        {t("newsletter.success")}
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <input
          type="email"
          id="blog-newsletter-email"
          name="EMAIL"
          required
          autocomplete="email"
          placeholder={t("newsletter.email.placeholder")}
          class="flex-1 h-10 px-3 text-sm rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition"
        />
        <button
          type="submit"
          class="h-10 px-5 text-sm rounded-lg bg-foreground text-background font-medium hover:bg-foreground/90 transition-colors flex items-center justify-center gap-2 whitespace-nowrap disabled:opacity-50"
        >
          <span class="blog-btn-text">{t("newsletter.button")}</span>
          <svg class="blog-btn-loader hidden w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>

      <div class="flex items-start gap-2">
        <input
          type="checkbox"
          id="blog-newsletter-optin"
          name="OPT_IN"
          value="1"
          required
          class="mt-0.5 h-3.5 w-3.5 rounded border-border text-primary focus:ring-primary/50"
        />
        <label for="blog-newsletter-optin" class="text-xs text-muted-foreground leading-relaxed">
          {t("newsletter.optin")}
        </label>
      </div>

      <div
        id="blog-newsletter-captcha"
        class="cf-turnstile"
        data-sitekey={turnstileSiteKey}
        data-callback="handleBlogNewsletterCaptcha"
        data-theme="auto"
        data-size="compact"
      ></div>

      <input type="text" name="email_address_check" value="" class="hidden" tabindex="-1" aria-hidden="true" />
      <input type="hidden" name="locale" value={lang} />
    </form>
  </div>
</div>

<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  (window as any).handleBlogNewsletterCaptcha = function() {
    const event = new Event('captchaChange');
    document.getElementById('blog-newsletter-captcha')?.dispatchEvent(event);
  };

  const form = document.getElementById('blog-newsletter-form') as HTMLFormElement;
  const errorEl = document.getElementById('blog-newsletter-error');
  const successEl = document.getElementById('blog-newsletter-success');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const btnText = btn.querySelector('.blog-btn-text');
    const btnLoader = btn.querySelector('.blog-btn-loader');

    btn.disabled = true;
    btnText?.classList.add('hidden');
    btnLoader?.classList.remove('hidden');
    errorEl?.classList.add('hidden');
    successEl?.classList.add('hidden');

    try {
      const formData = new FormData(form);
      await fetch(form.action, {
        method: 'POST',
        body: formData,
        mode: 'no-cors'
      });

      successEl?.classList.remove('hidden');
      form.reset();

      if ((window as any).turnstile) {
        (window as any).turnstile.reset();
      }
    } catch {
      errorEl?.classList.remove('hidden');
    } finally {
      btn.disabled = false;
      btnText?.classList.remove('hidden');
      btnLoader?.classList.add('hidden');
    }
  });
</script>
