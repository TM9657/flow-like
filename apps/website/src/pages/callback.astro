---
import "@tm9657/flow-like-ui/global.css";
import Layout from "../layouts/Layout.astro";
---

<Layout>
    <div class="flex flex-col items-center justify-center h-screen">
        <h1>Redirecting...</h1>
        <p class="mt-2 text-sm text-gray-500">If nothing happens, <a id="deeplink" class="underline" href="#">click here</a>.</p>
    </div>
    <script>
        (function () {
            try {
                var isIOS =
                    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

                var search = new URLSearchParams(window.location.search);
                var hash = window.location.hash ? window.location.hash.substring(1) : "";
                if (hash) {
                    var hashParams = new URLSearchParams(hash);
                    hashParams.forEach(function (v, k) { search.set(k, v); });
                }
                var qs = search.toString();

                var universalLink = "https://app.flow-like.com/callback" + (qs ? "?" + qs : "");
                var legacyDeepLink = "flow-like://auth" + (qs ? "?" + qs : "");
                var primaryTarget = isIOS ? universalLink : legacyDeepLink;
                var fallbackTarget = isIOS ? legacyDeepLink : null;

                var link = document.getElementById("deeplink");
                if (link) link.setAttribute("href", primaryTarget);

                var leftPage = false;
                var markLeftPage = function () { leftPage = true; };
                window.addEventListener("pagehide", markLeftPage, { once: true });
                document.addEventListener("visibilitychange", function () {
                    if (document.visibilityState === "hidden") {
                        leftPage = true;
                    }
                });

                window.location.replace(primaryTarget);

                // iOS native path first; keep legacy scheme fallback for older app versions.
                if (fallbackTarget) {
                    window.setTimeout(function () {
                        var fallback = fallbackTarget;
                        if (!fallback) return;
                        if (leftPage || document.visibilityState === "hidden") return;
                        if (link) link.setAttribute("href", fallback);
                        window.location.replace(fallback);
                    }, 1200);
                }
            } catch (_) { /* noop */ }
        })();
    </script>
</Layout>
