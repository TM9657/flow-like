---
import { getCollection } from "astro:content";
import "@tm9657/flow-like-ui/global.css";
import "../../styles/blog.css";
import BlogLayout from "../../layouts/Blog-Layout.astro";
import BlogNewsletter from "../../components/blog-newsletter.astro";
import { LuCopy, LuShare } from "react-icons/lu";

export async function getStaticPaths() {
  const all = await getCollection("blog", ({ data }) =>
    import.meta.env.PROD ? !data.draft : true,
  );
  return all.map((entry) => ({
    params: { slug: entry.slug.split("-").slice(3).join("-") },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { title, description, date, tags = [], cover } = entry.data;
const postCover = cover;

const site = Astro.site ?? import.meta.env.SITE;
const canonical = site ? new URL(Astro.url.pathname, site).toString() : "";
---

<BlogLayout data={entry.data} content={Content}>
  <div class="mx-auto w-full max-w-6xl px-4 sm:px-6 lg:px-8 pb-12 sm:pb-14 lg:pb-16">
    <a
      href="/blog/"
      class="mb-8 inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3.5 py-1.5 text-sm text-muted-foreground transition hover:border-border hover:text-foreground"
    >
      <span aria-hidden="true">←</span>
      Back to blog
    </a>

    <header class="mb-10 overflow-hidden rounded-2xl border border-border/50 bg-card/50 backdrop-blur-sm">
      {postCover && (
        <div class="relative overflow-hidden border-b border-border/40">
          <img
            src={postCover}
            alt=""
            class="h-56 w-full object-cover sm:h-64 md:h-72 lg:h-80"
            loading="eager"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/25 via-transparent to-transparent" />
        </div>
      )}

      <div class="p-6 sm:p-8 lg:p-10">
        <h1 class="m-0 text-3xl font-bold tracking-tight leading-[1.08] sm:text-4xl lg:text-5xl">
          {title}
        </h1>

        {description && (
          <p class="mt-4 max-w-4xl text-base leading-relaxed text-muted-foreground sm:text-lg">
            {description}
          </p>
        )}

        <div class="mt-5 flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-muted-foreground">
          <time datetime={new Date(date).toISOString()} class="whitespace-nowrap">
            {new Date(date).toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            })}
          </time>
          <span aria-hidden="true" class="text-zinc-300 dark:text-zinc-700">·</span>
          <span id="reading-time" class="whitespace-nowrap">— min read</span>
        </div>

        {tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {tags.map((t: string) => (
              <a
                href={`/tags/${encodeURIComponent(t)}/`}
                class="inline-flex items-center rounded-full border border-border/60 bg-background/60 px-3 py-1 text-xs font-medium text-muted-foreground transition hover:border-border hover:text-foreground"
              >
                #{t}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>

    <div class="mb-10 border-t border-border/50" />

    <div class="grid gap-10 lg:grid-cols-[minmax(0,1fr)_260px] xl:gap-12 xl:grid-cols-[minmax(0,1fr)_280px]">
      <article
        id="post-content"
        class="post-prose prose prose-zinc dark:prose-invert max-w-none prose-headings:scroll-mt-20 first-h1-hidden"
      >
        <Content />

        <BlogNewsletter />

        <hr class="my-8" />
        <div class="not-prose flex flex-wrap items-center justify-between gap-3 text-sm">
          <div class="flex flex-wrap gap-2.5">
            {
              tags.map((t: string) => (
                <a
                  href={`/tags/${encodeURIComponent(t)}/`}
                  class="text-muted-foreground transition hover:text-foreground"
                >
                  #{t}
                </a>
              ))
            }
          </div>
          <div class="flex items-center gap-2">
            <button
              data-copy-link
              class="flex flex-row items-center gap-2 rounded-md border px-2.5 py-1.5 text-xs transition hover:bg-accent"
            >
              <LuCopy />
              Copy link
            </button>
            <button
              data-web-share
              class="flex flex-row items-center gap-2 rounded-md border px-2.5 py-1.5 text-xs transition hover:bg-accent"
            >
              <LuShare />
              Share
            </button>
          </div>
        </div>
      </article>

      <aside class="hidden lg:block">
        {
          headings?.length > 0 && (
            <nav class="sticky top-24 rounded-xl border border-border/50 bg-card/40 p-4 text-sm backdrop-blur-sm">
              <p class="mb-3 text-xs font-medium uppercase tracking-wider text-muted-foreground">
                On this page
              </p>
              <ul class="space-y-1.5">
                {headings
                  .filter((h) => h.depth <= 3 && h.slug)
                  .map((h) => (
                    <li class="toc-item" style={`padding-left: ${(h.depth - 1) * 10}px`}>
                      <a
                        href={`#${h.slug}`}
                        data-slug={h.slug}
                        class="toc-link block rounded-md px-2 py-1 text-[13px] text-muted-foreground transition hover:bg-muted/60 hover:text-foreground"
                      >
                        {h.text}
                      </a>
                    </li>
                  ))}
              </ul>
            </nav>
          )
        }
      </aside>
    </div>
  </div>

  <div class="fixed inset-x-0 top-0 z-40 h-1">
    <div
      id="progress"
      class="h-full origin-left scale-x-0 bg-primary transition-[transform] duration-100"
    >
    </div>
  </div>

  <script type="module" define:vars={{ title, description, canonical }}>
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
    const raf = (fn) => requestAnimationFrame(fn);

    const article = $("#post-content");
    const bar = $("#progress");
    const timeEl = $("#reading-time");
    const copyBtn = $("[data-copy-link]");
    const shareBtn = $("[data-web-share]");

    const setProgress = () => {
      if (!article || !bar) return;
      const start = article.offsetTop;
      const end = start + article.offsetHeight - innerHeight;
      const p = clamp((scrollY - start) / (end - start), 0, 1);
      bar.style.transform = `scaleX(${p || 0})`;
    };

    const setReadingTime = () => {
      if (!article || !timeEl) return;
      const text = article.textContent || "";
      const words = (text.match(/\S+/g) || []).length;
      const mins = Math.max(1, Math.round(words / 200));
      timeEl.textContent = `${mins} min read`;
    };

    const getUrl = () => canonical || location.href;

    const copyLink = async () => {
      const url = getUrl();
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(url);
        } else {
          const ta = document.createElement("textarea");
          ta.value = url;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        if (copyBtn) {
          const old = copyBtn.textContent;
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = old || "Copy link"), 1200);
        }
      } catch {}
    };

    const webShare = async () => {
      const data = { title, text: description || "", url: getUrl() };
      if (navigator.share) {
        try {
          await navigator.share(data);
          return;
        } catch {}
      }
      copyLink();
    };

    copyBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      copyLink();
    });
    shareBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      webShare();
    });

    setReadingTime();
    setProgress();

    const links = $$(".toc-link");
    if (links.length) {
      const bySlug = Object.fromEntries(links.map((l) => [l.dataset.slug, l]));
      const obs = new IntersectionObserver(
        (entries) => {
          for (const e of entries) {
            const link = bySlug[e.target.id];
            if (!link) continue;
            link.classList.toggle("text-foreground", e.isIntersecting);
            link.classList.toggle("font-medium", e.isIntersecting);
          }
        },
        { rootMargin: "0px 0px -70% 0px", threshold: 0 },
      );
      $$("#post-content h2[id], #post-content h3[id]").forEach((h) =>
        obs.observe(h),
      );
    }

    addEventListener("scroll", () => requestAnimationFrame(setProgress), {
      passive: true,
    });
    addEventListener("resize", () => {
      raf(setProgress);
      if (window.updatePinConnections) raf(window.updatePinConnections);
    });

    const initPinConnections = () => {
      const headerEl = $("#cover-header");
      const svg = $("#pin-connections");
      const leftPin = $("#left-pin");
      const rightPin = $("#right-pin");
      const leftPinTop = $("#left-pin-top");
      const rightPinTop = $("#right-pin-top");

      if (!headerEl || !svg) return;

      const setViewBox = () => {
        const r = headerEl.getBoundingClientRect();
        svg.setAttribute("viewBox", `0 0 ${r.width} ${r.height}`);
        svg.setAttribute("width", String(r.width));
        svg.setAttribute("height", String(r.height));
      };

      const cubicPath = (pin, isRight) => {
        const hr = headerEl.getBoundingClientRect();
        const pr = pin.getBoundingClientRect();
        const sx = pr.left - hr.left + pr.width / 2;
        const sy = pr.top - hr.top + pr.height / 2;
        const ex = isRight ? hr.width + 200 : -200;
        const ey = sy + (isRight ? 40 : 80);
        const dx = ex - sx;
        const cp1x = sx + dx * 0.4;
        const cp2x = sx + dx * 0.8;
        return `M${sx},${sy} C${cp1x},${sy} ${cp2x},${ey} ${ex},${ey}`;
      };

      const straightPath = (pin, isRight) => {
        const hr = headerEl.getBoundingClientRect();
        const pr = pin.getBoundingClientRect();
        const sx = pr.left - hr.left + pr.width / 2;
        const sy = pr.top - hr.top + pr.height / 2;
        const ex = isRight ? hr.width + 300 : -300;
        const ey = sy + (isRight ? -20 : 20);
        const cp1x = sx + (ex - sx) * 0.6;
        return `M${sx},${sy} Q${cp1x},${sy} ${ex},${ey}`;
      };

      const animateStroke = (path) => {
        const len = path.getTotalLength();
        path.style.setProperty("--len", String(len));
        path.style.animation = "none";
        path.offsetWidth;
        path.style.animation = "";
      };

      const updatePaths = () => {
        setViewBox();

        if (rightPin) {
          const rightConn = $("#right-conn");
          if (rightConn) {
            rightConn.setAttribute("d", cubicPath(rightPin, true));
            animateStroke(rightConn);
          }
        }

        if (leftPin) {
          const leftConn = $("#left-conn");
          if (leftConn) {
            leftConn.setAttribute("d", cubicPath(leftPin, false));
            animateStroke(leftConn);
          }
        }

        if (rightPinTop) {
          const rightConnTop = $("#right-conn-top");
          if (rightConnTop) {
            rightConnTop.setAttribute("d", straightPath(rightPinTop, true));
          }
        }

        if (leftPinTop) {
          const leftConnTop = $("#left-conn-top");
          if (leftConnTop) {
            leftConnTop.setAttribute("d", straightPath(leftPinTop, false));
          }
        }
      };

      updatePaths();
      window.updatePinConnections = updatePaths;
    };

    if ($("#cover-header")) {
      initPinConnections();
    }
  </script>

  <style>
    .post-prose {
      padding-inline: 0;
    }

    .toc-link.font-medium {
      color: var(--foreground);
    }

    .pin-conn-solid {
      stroke: currentColor;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      vector-effect: non-scaling-stroke;
    }

    .pin-conn {
      stroke: currentColor;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
      vector-effect: non-scaling-stroke;
      stroke-dasharray: 10 10;
      animation: flow-dots 0.4s linear infinite;
    }

    @keyframes draw-conn {
      from {
        stroke-dashoffset: var(--len, 100);
      }
      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes flow-dots {
      to {
        stroke-dashoffset: -20px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      #progress {
        transition: none;
      }
      .pin-conn {
        animation: draw-conn 900ms ease-out forwards;
      }
    }
  </style>
</BlogLayout>
