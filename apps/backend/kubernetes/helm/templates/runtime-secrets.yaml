{{/* External database secret - only created when using external database without existingSecret */}}
{{- if and (eq (include "flow-like.databaseMode" .) "external") (eq (default "" .Values.database.external.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-db-external
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  DATABASE_URL: {{ required "database.external.connectionString is required when database.type=external" .Values.database.external.connectionString | quote }}
---
{{- end }}

{{/* Storage secrets based on provider */}}
{{- $provider := default "s3" .Values.storage.provider }}

{{/* AWS S3 Storage Secret */}}
{{- if and (eq $provider "aws") (eq (default "" .Values.storage.aws.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-storage
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  STORAGE_PROVIDER: "aws"
  AWS_ACCESS_KEY_ID: {{ .Values.storage.aws.accessKeyId | quote }}
  AWS_SECRET_ACCESS_KEY: {{ .Values.storage.aws.secretAccessKey | quote }}
  AWS_REGION: {{ default "us-east-1" .Values.storage.aws.region | quote }}
  {{- if .Values.storage.aws.endpoint }}
  AWS_ENDPOINT: {{ .Values.storage.aws.endpoint | quote }}
  {{- end }}
  AWS_USE_PATH_STYLE: {{ default "false" .Values.storage.aws.usePathStyle | quote }}
  {{- if .Values.storage.aws.runtimeRoleArn }}
  RUNTIME_ROLE_ARN: {{ .Values.storage.aws.runtimeRoleArn | quote }}
  {{- end }}
  META_BUCKET: {{ default "flow-like-meta" .Values.storage.aws.metaBucket | quote }}
  CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.aws.contentBucket | quote }}
  LOG_BUCKET: {{ default "flow-like-logs" .Values.storage.aws.logBucket | quote }}
  {{- if and .Values.jwt (not .Values.jwt.existingSecret) }}
  BACKEND_KEY: {{ required "jwt.backendKey is required" .Values.jwt.backendKey | quote }}
  BACKEND_PUB: {{ required "jwt.backendPub is required" .Values.jwt.backendPub | quote }}
  BACKEND_KID: {{ default "backend-es256-v1" .Values.jwt.backendKid | quote }}
  {{- end }}
---
{{- end }}

{{/* Azure Blob Storage Secret */}}
{{- if and (eq $provider "azure") (eq (default "" .Values.storage.azure.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-storage
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  STORAGE_PROVIDER: "azure"
  AZURE_STORAGE_ACCOUNT_NAME: {{ required "storage.azure.accountName is required" .Values.storage.azure.accountName | quote }}
  AZURE_STORAGE_ACCOUNT_KEY: {{ required "storage.azure.accountKey is required" .Values.storage.azure.accountKey | quote }}
  AZURE_META_CONTAINER: {{ default "flow-like-meta" .Values.storage.azure.metaContainer | quote }}
  AZURE_CONTENT_CONTAINER: {{ default "flow-like-content" .Values.storage.azure.contentContainer | quote }}
  AZURE_LOG_CONTAINER: {{ default "logs" .Values.storage.azure.logContainer | quote }}
  META_BUCKET: {{ default "flow-like-meta" .Values.storage.azure.metaContainer | quote }}
  CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.azure.contentContainer | quote }}
  {{- if and .Values.jwt (not .Values.jwt.existingSecret) }}
  BACKEND_KEY: {{ required "jwt.backendKey is required" .Values.jwt.backendKey | quote }}
  BACKEND_PUB: {{ required "jwt.backendPub is required" .Values.jwt.backendPub | quote }}
  BACKEND_KID: {{ default "backend-es256-v1" .Values.jwt.backendKid | quote }}
  {{- end }}
---
{{- end }}

{{/* GCP Cloud Storage Secret */}}
{{- if and (eq $provider "gcp") (eq (default "" .Values.storage.gcp.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-storage
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  STORAGE_PROVIDER: "gcp"
  GCP_PROJECT_ID: {{ required "storage.gcp.projectId is required" .Values.storage.gcp.projectId | quote }}
  {{- if .Values.storage.gcp.serviceAccountKey }}
  GOOGLE_APPLICATION_CREDENTIALS_JSON: {{ .Values.storage.gcp.serviceAccountKey | quote }}
  {{- end }}
  GCP_META_BUCKET: {{ default "flow-like-meta" .Values.storage.gcp.metaBucket | quote }}
  GCP_CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.gcp.contentBucket | quote }}
  GCP_LOG_BUCKET: {{ default "flow-like-logs" .Values.storage.gcp.logBucket | quote }}
  META_BUCKET: {{ default "flow-like-meta" .Values.storage.gcp.metaBucket | quote }}
  CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.gcp.contentBucket | quote }}
  LOG_BUCKET: {{ default "flow-like-logs" .Values.storage.gcp.logBucket | quote }}
  {{- if and .Values.jwt (not .Values.jwt.existingSecret) }}
  BACKEND_KEY: {{ required "jwt.backendKey is required" .Values.jwt.backendKey | quote }}
  BACKEND_PUB: {{ required "jwt.backendPub is required" .Values.jwt.backendPub | quote }}
  BACKEND_KID: {{ default "backend-es256-v1" .Values.jwt.backendKid | quote }}
  {{- end }}
---
{{- end }}

{{/* S3-Compatible Storage Secret */}}
{{- if and (eq $provider "s3") (eq (default "" .Values.storage.s3.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-storage
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  STORAGE_PROVIDER: "s3"
  S3_ENDPOINT: {{ required "storage.s3.endpoint is required" .Values.storage.s3.endpoint | quote }}
  S3_REGION: {{ default "us-east-1" .Values.storage.s3.region | quote }}
  S3_ACCESS_KEY_ID: {{ required "storage.s3.accessKeyId is required" .Values.storage.s3.accessKeyId | quote }}
  S3_SECRET_ACCESS_KEY: {{ required "storage.s3.secretAccessKey is required" .Values.storage.s3.secretAccessKey | quote }}
  S3_USE_PATH_STYLE: {{ default "true" .Values.storage.s3.usePathStyle | quote }}
  META_BUCKET: {{ default "flow-like-meta" .Values.storage.s3.metaBucket | quote }}
  CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.s3.contentBucket | quote }}
  LOG_BUCKET: {{ default "flow-like-logs" .Values.storage.s3.logBucket | quote }}
  {{- if and .Values.jwt (not .Values.jwt.existingSecret) }}
  BACKEND_KEY: {{ required "jwt.backendKey is required" .Values.jwt.backendKey | quote }}
  BACKEND_PUB: {{ required "jwt.backendPub is required" .Values.jwt.backendPub | quote }}
  BACKEND_KID: {{ default "backend-es256-v1" .Values.jwt.backendKid | quote }}
  {{- end }}
{{- end }}

{{/* Cloudflare R2 Storage Secret */}}
{{- if and (eq $provider "r2") (eq (default "" .Values.storage.r2.existingSecret) "") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flow-like.fullname" . }}-storage
  labels:
    {{- include "flow-like.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
type: Opaque
stringData:
  STORAGE_PROVIDER: "r2"
  R2_ACCOUNT_ID: {{ required "storage.r2.accountId is required" .Values.storage.r2.accountId | quote }}
  R2_ACCESS_KEY_ID: {{ required "storage.r2.accessKeyId is required" .Values.storage.r2.accessKeyId | quote }}
  R2_SECRET_ACCESS_KEY: {{ required "storage.r2.secretAccessKey is required" .Values.storage.r2.secretAccessKey | quote }}
  META_BUCKET: {{ default "flow-like-meta" .Values.storage.r2.metaBucket | quote }}
  CONTENT_BUCKET: {{ default "flow-like-content" .Values.storage.r2.contentBucket | quote }}
  LOG_BUCKET: {{ default "flow-like-logs" .Values.storage.r2.logBucket | quote }}
  {{- if and .Values.jwt (not .Values.jwt.existingSecret) }}
  BACKEND_KEY: {{ required "jwt.backendKey is required" .Values.jwt.backendKey | quote }}
  BACKEND_PUB: {{ required "jwt.backendPub is required" .Values.jwt.backendPub | quote }}
  BACKEND_KID: {{ default "backend-es256-v1" .Values.jwt.backendKid | quote }}
  {{- end }}
{{- end }}


